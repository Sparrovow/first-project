import os
import cv2
import numpy as np
from deepface import DeepFace
from PIL import Image, ImageDraw, ImageFont

def draw_label_cn(img_cv2, text, x, y, font_path=r"C:\Windows\Fonts\simhei.ttf", font_size=20, color=(255, 255, 255)):
    img_pil = Image.fromarray(cv2.cvtColor(img_cv2, cv2.COLOR_BGR2RGB))
    draw = ImageDraw.Draw(img_pil)
    font = ImageFont.truetype(font_path, font_size)
    draw.text((x, y), text, font=font, fill=color)
    return cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR)

def detect_and_display_face(image_path):
    try:
        results = DeepFace.analyze(
            img_path=image_path,
            actions=['gender', 'race'],
            enforce_detection=False,
            detector_backend='retinaface'
        )

        # å…¼å®¹å¤šæ¨¡å‹ç»“æ„
        if isinstance(results, list):
            faces = results
        elif isinstance(results, dict) and "instance_1" in results:
            faces = list(results.values())
        else:
            faces = [results]

        img = cv2.imread(image_path)

        for face in faces:
            region = face.get("region", None)
            if not region:
                continue

            x, y, w, h = region.get("x", 0), region.get("y", 0), region.get("w", 0), region.get("h", 0)
            x, y = max(0, x), max(0, y)

            # è·å–æ€§åˆ«
            gender = face.get("gender", "æœªçŸ¥")
            if isinstance(gender, dict):
                gender = max(gender.items(), key=lambda item: item[1])[0]

            # è·å–äººç§
            race_info = face.get("race", {})
            if isinstance(race_info, dict):
                race = max(race_info.items(), key=lambda item: item[1])[0]
            else:
                race = "æœªçŸ¥"

            gender_cn = "ç”·" if gender.lower() == "man" else "å¥³" if gender.lower() == "woman" else gender
            race_map = {
                "asian": "äºšæ´²äºº", "white": "ç™½äºº", "black": "é»‘äºº",
                "indian": "å°åº¦äºº", "middle eastern": "ä¸­ä¸œäºº", "latino hispanic": "æ‹‰ä¸è£”"
            }
            race_cn = race_map.get(race.lower(), race)

            label = f"{gender_cn} Â· {race_cn}"

            cv2.rectangle(img, (x, y), (x + w, y + h), (0, 255, 0), 2)
            img = draw_label_cn(img, label, x, y - 25)

        return img

    except Exception as e:
        print(f"âŒ æ£€æµ‹å¤±è´¥: {str(e)}")
        return None

# ä¸»ç¨‹åº
input_folder = r"D:\photooo"
output_folder = r"D:\result"
os.makedirs(output_folder, exist_ok=True)

for filename in os.listdir(input_folder):
    if not filename.lower().endswith(('.jpg', '.jpeg', '.png')):
        continue

    image_path = os.path.join(input_folder, filename)
    output_path = os.path.join(output_folder, filename)

    print(f"--- å¼€å§‹å¤„ç†: {filename} ---")
    result_img = detect_and_display_face(image_path)

    if result_img is not None:
        cv2.imwrite(output_path, result_img)
        print(f"âœ… å·²ä¿å­˜: {output_path}")
    else:
        print(f"âš ï¸ å›¾åƒå¤„ç†å¤±è´¥: {filename}")

print("ğŸ‰ æ‰€æœ‰å›¾ç‰‡å¤„ç†å®Œæˆï¼")
